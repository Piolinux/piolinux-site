<script>
function calculateIP() {
    const input = document.getElementById('ipInput').value.trim();
    let resultHTML = '';

    try {
        let ip, mask, cidr, network, broadcast, totalHosts, usableRange;

        // Parse input
        if (input.includes('/')) {
            const parts = input.split('/');
            ip = parts[0];
            cidr = parseInt(parts[1]);
            if (isNaN(cidr) || cidr < 0 || cidr > 32) throw new Error('CIDR deve ser entre 0 e 32');
            mask = cidrToMask(cidr);
        } else if (input.includes(' ')) {
            const parts = input.split(' ');
            ip = parts[0];
            mask = parts[1];
            cidr = maskToCidr(mask);
            if (cidr === -1) throw new Error('M√°scara inv√°lida - deve ser cont√≠gua (ex: 255.255.255.0)');
        } else {
            throw new Error('Use formato IP/CIDR ou IP M√ÅSCARA');
        }

        // Validate
        if (!isValidIP(ip)) throw new Error('IP inv√°lido - use formato xxx.xxx.xxx.xxx (0-255)');
        if (!isValidMask(mask)) throw new Error('M√°scara inv√°lida - use formato xxx.xxx.xxx.xxx');

        // Calculate
        network = calculateNetwork(ip, mask);
        broadcast = calculateBroadcast(ip, mask);
        totalHosts = Math.pow(2, 32 - cidr) - 2;
        const firstHost = incrementIP(network);
        const lastHost = decrementIP(broadcast);
        usableRange = `${firstHost} - ${lastHost}`;

        // Build result with explanations
        resultHTML = `
            <div style="background: #121212; padding: 15px; border-radius: 6px; border: 1px solid #333;">
                <div style="color: #8bc34a; font-weight: bold; margin-bottom: 10px;">‚úÖ C√°lculo Completo</div>
                
                <div style="margin: 8px 0; padding: 8px; background: #1a2a1a; border-radius: 4px;">
                    <span style="color: #8bc34a;">IP:</span> ${ip}
                </div>
                
                <div style="margin: 8px 0; padding: 8px; background: #1a2a1a; border-radius: 4px;">
                    <span style="color: #8bc34a;">M√°scara:</span> ${mask} <span style="color: #aaa;">(${cidr})</span>
                    <div style="font-size: 0.9em; color: #aaa; margin-top: 4px;"># ${getMaskExplanation(cidr)}</div>
                </div>
                
                <div style="margin: 8px 0; padding: 8px; background: #1a2a1a; border-radius: 4px;">
                    <span style="color: #8bc34a;">Rede:</span> ${network}
                    <div style="font-size: 0.9em; color: #aaa; margin-top: 4px;"># Endere√ßo da rede (n√£o atribu√≠vel)</div>
                </div>
                
                <div style="margin: 8px 0; padding: 8px; background: #1a2a1a; border-radius: 4px;">
                    <span style="color: #8bc34a;">Broadcast:</span> ${broadcast}
                    <div style="font-size: 0.9em; color: #aaa; margin-top: 4px;"># Endere√ßo de broadcast (n√£o atribu√≠vel)</div>
                </div>
                
                <div style="margin: 8px 0; padding: 8px; background: #1a2a1a; border-radius: 4px;">
                    <span style="color: #8bc34a;">Hosts utiliz√°veis:</span> ${totalHosts.toLocaleString()}
                    <div style="font-size: 0.9em; color: #aaa; margin-top: 4px;"># Faixa: ${usableRange}</div>
                </div>
            </div>
            
            <div style="background: #330000; color: #ff5252; padding: 10px; border-radius: 6px; margin-top: 15px; border: 1px solid #ff5252;">
                ‚ö†Ô∏è <strong>Aten√ß√£o Sysadmin:</strong> Sempre reserve os primeiros IPs da rede para gateways e servidores!
            </div>
        `;
    } catch (e) {
        resultHTML = `
            <div style="background: #330000; color: #ff5252; padding: 15px; border-radius: 6px; border: 1px solid #ff5252;">
                ‚ùå ${e.message}
            </div>
            <div style="background: #1a2a1a; color: #aaa; padding: 15px; border-radius: 6px; margin-top: 10px;">
                <strong>üìå Formatos v√°lidos:</strong><br>
                ‚Ä¢ <code>192.168.1.100/24</code> (CIDR)<br>
                ‚Ä¢ <code>10.0.0.1 255.255.255.0</code> (m√°scara decimal)<br><br>
                <strong>üí° Dica:</strong> Use /24 para redes pequenas (254 hosts), /16 para redes grandes (65.534 hosts)
            </div>
        `;
    }

    document.getElementById('ipResult').innerHTML = resultHTML;
}

// Helper functions
function cidrToMask(cidr) {
    const mask = [0, 0, 0, 0];
    for (let i = 0; i < cidr; i++) {
        mask[Math.floor(i / 8)] += 1 << (7 - i % 8);
    }
    return mask.join('.');
}

function maskToCidr(mask) {
    const parts = mask.split('.');
    if (parts.length !== 4) return -1;
    
    let cidr = 0;
    for (let part of parts) {
        const num = parseInt(part);
        if (isNaN(num) || num < 0 || num > 255) return -1;
        const bin = num.toString(2).padStart(8, '0');
        cidr += (bin.match(/1/g) || []).length;
        
        // Check for non-contiguous masks
        const firstZero = bin.indexOf('0');
        if (firstZero !== -1 && bin.slice(firstZero).includes('1')) {
            return -1;
        }
    }
    return cidr;
}

function calculateNetwork(ip, mask) {
    return ip.split('.').map((octet, i) => {
        return parseInt(octet) & parseInt(mask.split('.')[i]);
    }).join('.');
}

function calculateBroadcast(ip, mask) {
    return ip.split('.').map((octet, i) => {
        return parseInt(octet) | (255 - parseInt(mask.split('.')[i]));
    }).join('.');
}

function isValidIP(ip) {
    const parts = ip.split('.');
    if (parts.length !== 4) return false;
    return parts.every(part => {
        const num = parseInt(part);
        return !isNaN(num) && num >= 0 && num <= 255;
    });
}

function isValidMask(mask) {
    const parts = mask.split('.');
    if (parts.length !== 4) return false;
    const binary = parts.map(p => parseInt(p).toString(2).padStart(8, '0')).join('');
    const firstZero = binary.indexOf('0');
    if (firstZero === -1) return true;
    return binary.slice(firstZero).indexOf('1') === -1;
}

function getMaskExplanation(cidr) {
    const explanations = {
        32: "Host √∫nico (m√°scara 255.255.255.255)",
        30: "2 hosts (links ponto-a-ponto)",
        29: "6 hosts (pequenas sub-redes)",
        28: "14 hosts",
        27: "30 hosts",
        26: "62 hosts",
        25: "126 hosts",
        24: "254 hosts (rede classe C padr√£o)",
        23: "510 hosts",
        22: "1022 hosts",
        21: "2046 hosts",
        20: "4094 hosts",
        19: "8190 hosts",
        18: "16382 hosts",
        17: "32766 hosts",
        16: "65534 hosts (rede classe B padr√£o)",
        8: "16.777.214 hosts (rede classe A padr√£o)"
    };
    return explanations[cidr] || `${Math.pow(2, 32 - cidr) - 2} hosts utiliz√°veis`;
}

function incrementIP(ip) {
    const parts = ip.split('.').map(Number);
    for (let i = 3; i >= 0; i--) {
        if (parts[i] < 255) {
            parts[i]++;
            break;
        }
        parts[i] = 0;
    }
    return parts.join('.');
}

function decrementIP(ip) {
    const parts = ip.split('.').map(Number);
    for (let i = 3; i >= 0; i--) {
        if (parts[i] > 0) {
            parts[i]--;
            break;
        }
        parts[i] = 255;
    }
    return parts.join('.');
}
</script>
